@page "/patient/edit-profile"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Patient")]
@using Clinix.Application.Dtos
@using Clinix.Application.Dtos.Patient
@using Clinix.Web.Services
@inject IPatientDashboardUiService DashboardUiService
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager NavigationManager
@inject Blazored.Toast.Services.IToastService ToastService
@using Blazored.FluentValidation

<div class="edit-profile-page">

    <div class="page-header">
        <div>
            <h1 class="page-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                </svg>
                Edit Profile
            </h1>
            <p class="page-subtitle">Update your personal and medical information</p>
        </div>
        <button class="btn btn-secondary" @onclick="Cancel">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Back to Dashboard
        </button>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Loading your profile...</p>
        </div>
    }
    else
    {
        <EditForm Model="model" OnValidSubmit="OnValidSubmit" class="edit-profile-form">
            <FluentValidationValidator />

            <div class="card form-section-card">
                <div class="card-header">
                    <h5 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                        Personal Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fullname" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                                </svg>
                                Full Name
                            </label>
                            <InputText id="fullname" class="form-control" @bind-Value="model.FullName" placeholder="Enter your full name" />
                            <ValidationMessage For="@(() => model.FullName)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="email" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4z"/>
                                </svg>
                                Email Address
                            </label>
                            <InputText id="email" class="form-control" @bind-Value="model.Email" placeholder="your.email@example.com" />
                            <ValidationMessage For="@(() => model.Email)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="dob" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5z"/>
                                </svg>
                                Date of Birth
                            </label>
                            <InputDate id="dob" class="form-control" @bind-Value="model.DateOfBirth" />
                            <ValidationMessage For="@(() => model.DateOfBirth)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="gender" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 1a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3z"/>
                                </svg>
                                Gender
                            </label>
                            <InputSelect id="gender" class="form-select" @bind-Value="model.Gender">
                                <option value="">Select Gender</option>
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => model.Gender)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="bloodGroup" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917z"/>
                                </svg>
                                Blood Group
                            </label>
                            <InputSelect id="bloodGroup" class="form-select" @bind-Value="model.BloodGroup">
                                <option value="">Select Blood Group</option>
                                <option>A+</option><option>A-</option>
                                <option>B+</option><option>B-</option>
                                <option>O+</option><option>O-</option>
                                <option>AB+</option><option>AB-</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => model.BloodGroup)" class="validation-message" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="card form-section-card">
                <div class="card-header">
                    <h5 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328z"/>
                        </svg>
                        Emergency Contact
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="emergencyContactName" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                                </svg>
                                Contact Name
                            </label>
                            <InputText id="emergencyContactName" class="form-control" @bind-Value="model.EmergencyContactName" placeholder="Enter contact name" />
                            <ValidationMessage For="@(() => model.EmergencyContactName)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="emergencyContactNumber" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328z"/>
                            </svg>
                            Contact Number
                            </label>
                            <InputText id="emergencyContactNumber" class="form-control" @bind-Value="model.EmergencyContactNumber" placeholder="Enter contact number" />
                            <ValidationMessage For="@(() => model.EmergencyContactNumber)" class="validation-message" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="card form-section-card">
                <div class="card-header">
                    <h5 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        Medical Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="knownAllergies" class="form-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                            </svg>
                            Known Allergies
                        </label>
                        <InputTextArea id="knownAllergies" class="form-control textarea-control" @bind-Value="model.KnownAllergies" rows="3" placeholder="List any known allergies (e.g., penicillin, peanuts)" />
                        <ValidationMessage For="@(() => model.KnownAllergies)" class="validation-message" />
                    </div>

                    <div class="form-group">
                        <label for="existingConditions" class="form-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
                            </svg>
                            Existing Medical Conditions
                        </label>
                        <InputTextArea id="existingConditions" class="form-control textarea-control" @bind-Value="model.ExistingConditions" rows="3" placeholder="List any existing medical conditions (e.g., diabetes, hypertension)" />
                        <ValidationMessage For="@(() => model.ExistingConditions)" class="validation-message" />
                    </div>
                </div>
            </div>

            <div class="action-buttons-container">
                <button class="btn btn-primary btn-lg submit-button" type="submit" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="button-content">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                            <span>Saving Changes...</span>
                        </span>
                    }
                    else
                    {
                        <span class="button-content">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                            </svg>
                            <span>Save Changes</span>
                        </span>
                    }
                </button>

                <button class="btn btn-secondary btn-lg" type="button" @onclick="Cancel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                    Cancel
                </button>
            </div>
        </EditForm>
    }
</div>

<style>
    .edit-profile-page {
        padding: var(--clx-spacing-lg);
        max-width: 900px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--clx-spacing-xl);
        gap: var(--clx-spacing-md);
    }

    .page-title {
        display: flex;
        align-items: center;
        gap: var(--clx-spacing-sm);
        margin: 0 0 var(--clx-spacing-xs) 0;
        color: var(--clx-gray-900);
        font-size: 1.75rem;
    }

    .page-title svg {
        color: var(--clx-primary);
    }

    .page-subtitle {
        color: var(--clx-gray-600);
        font-size: 0.875rem;
        margin: 0;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--clx-spacing-2xl);
        text-align: center;
    }

    .edit-profile-form {
        display: flex;
        flex-direction: column;
        gap: var(--clx-spacing-lg);
    }

    .form-section-card {
        box-shadow: var(--clx-shadow-md);
    }

    .form-section-card .card-header {
        background-color: var(--clx-gray-50);
        border-bottom: 2px solid var(--clx-gray-200);
        padding: var(--clx-spacing-lg);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: var(--clx-spacing-sm);
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--clx-gray-900);
    }

    .section-title svg {
        color: var(--clx-primary);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--clx-spacing-lg);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--clx-spacing-sm);
    }

    .form-label {
        display: flex;
        align-items: center;
        gap: var(--clx-spacing-xs);
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--clx-gray-700);
    }

    .form-label svg {
        color: var(--clx-primary);
    }

    .form-control,
    .form-select {
        padding: var(--clx-spacing-md);
        font-size: 0.9375rem;
        border: 2px solid var(--clx-gray-300);
        border-radius: var(--clx-radius-md);
        transition: all var(--clx-transition-normal);
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--clx-primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(var(--clx-primary-rgb), 0.1);
    }

    .textarea-control {
        resize: vertical;
        min-height: 80px;
    }

    .validation-message {
        color: var(--clx-danger);
        font-size: 0.8125rem;
        margin-top: var(--clx-spacing-xs);
    }

    .action-buttons-container {
        display: flex;
        gap: var(--clx-spacing-md);
        margin-top: var(--clx-spacing-lg);
    }

    .action-buttons-container .btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--clx-spacing-sm);
        height: 52px;
        font-weight: 600;
    }

    .submit-button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: var(--clx-shadow-lg);
    }

    .submit-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .button-content {
        display: flex;
        align-items: center;
        gap: var(--clx-spacing-sm);
    }

    @@media (max-width: 768px) {
        .edit-profile-page {
            padding: var(--clx-spacing-md);
        }

        .page-header {
            flex-direction: column;
            align-items: stretch;
        }

        .page-header .btn {
            width: 100%;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons-container {
            flex-direction: column;
        }

        .action-buttons-container .btn {
            width: 100%;
        }
    }
</style>

@code {
    private PatientUpdateProfileRequest model = new();
    private bool isLoading = true;
    private bool isSubmitting;
    private CancellationTokenSource? cts;

    protected override async Task OnInitializedAsync()
    {
        cts = new CancellationTokenSource();
        isLoading = true;

        var auth = await AuthProvider.GetAuthenticationStateAsync();
        var user = auth.User;
        if (!(user.Identity?.IsAuthenticated ?? false))
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        var idClaim = user.FindFirst("UserId") ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
        if (idClaim == null || !long.TryParse(idClaim.Value, out var userId))
        {
            ToastService.ShowError("Unable to identify your account. Please login again.");
            NavigationManager.NavigateTo("/login", forceLoad: true);
            return;
        }

        model.UserId = userId;

        try
        {
            var dto = await DashboardUiService.GetDashboardAsync(userId, cts.Token);
            if (dto != null)
            {
                model.FullName = dto.FullName;
                model.Email = dto.Email;
                model.DateOfBirth = dto.DateOfBirth;
                model.Gender = dto.Gender;
                model.BloodGroup = dto.BloodGroup;
                model.EmergencyContactName = dto.EmergencyContactName;
                model.EmergencyContactNumber = dto.EmergencyContactNumber;
                model.KnownAllergies = dto.KnownAllergies;
                model.ExistingConditions = dto.ExistingConditions;
            }
        }
        catch (OperationCanceledException) { }
        catch (Exception)
        {
            ToastService.ShowError("Failed to load profile for editing.");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnValidSubmit()
    {
        if (isSubmitting) return;
        isSubmitting = true;

        try
        {
            var result = await DashboardUiService.UpdateProfileAsync(model, cts?.Token ?? CancellationToken.None);
            if (result.IsSuccess)
            {
                ToastService.ShowSuccess("Profile updated successfully.");
                NavigationManager.NavigateTo("/patient/dashboard", forceLoad: true);
            }
            else
            {
                ToastService.ShowError($"Could not update profile: {result.Error}");
            }
        }
        catch (OperationCanceledException) { }
        catch (Exception)
        {
            ToastService.ShowError("An unexpected error occurred while saving profile.");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/patient/dashboard");
    }

    public void Dispose()
    {
        if (cts != null)
        {
            cts.Cancel();
            cts.Dispose();
            cts = null;
        }
    }
}
