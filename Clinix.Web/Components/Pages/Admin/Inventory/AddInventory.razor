@page "/inventory/add"
@attribute [Authorize(Roles = "Admin, Chemist")] 
@rendermode InteractiveServer
@using Clinix.Application.Interfaces
@using Clinix.Application.Interfaces.ServiceInterfaces
@using Clinix.Domain.Entities
@using Clinix.Domain.Entities.Inventory
@inject IInventoryService InventoryService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<h3>Add New Inventory Item</h3>

@if (_accessDenied)
{
    <div class="alert alert-danger">Access denied. Only Admins and Chemists can add items.</div>
}
else
{
    <EditForm Model="_model" OnValidSubmit="HandleAdd" FormName="AddInvItem-Form">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Name</label>
            <InputText @bind-Value="_model.Name" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Type</label>
            <InputSelect @bind-Value="_model.Type" class="form-select">
                <option value="">Select Type</option>
                <option>Medicine</option>
                <option>Equipment</option>
                <option>Consumable</option>
            </InputSelect>
        </div>

        <div class="mb-3">
            <label>Category</label>
            <InputText @bind-Value="_model.Category" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Unit</label>
            <InputText @bind-Value="_model.Unit" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Min Stock</label>
            <InputNumber @bind-Value="_model.MinStock" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Stock Location</label>
            <InputText @bind-Value="_model.StockLocation" class="form-control" />
        </div>

        <button type="submit" class="btn btn-success w-100" disabled="@_isLoading">@_buttonText</button>
        <button type="button" class="btn btn-secondary w-100 mt-2" @onclick="@(() => Navigation.NavigateTo("/inventory"))">Cancel</button>
    </EditForm>

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="alert alert-danger mt-2">@_error</div>
    }
    @if (!string.IsNullOrEmpty(_success))
    {
        <div class="alert alert-success mt-2">@_success</div>
    }
}

@code {
    [SupplyParameterFromForm]
    private InventoryItem _model { get; set; } = new();
    private bool _isLoading;
    private string _buttonText = "Add Item";
    private string? _error;
    private string? _success;
    private bool _accessDenied;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (!user.IsInRole("Admin") && !user.IsInRole("Chemist"))
        {
            _accessDenied = true;
        }
    }

    private async Task HandleAdd()
    {
        _error = _success = null;
        _isLoading = true;
        _buttonText = "Adding...";

        try
        {
            await InventoryService.AddItemAsync(_model);
            _success = "Item added successfully!";
            await Task.Delay(800);
            Navigation.NavigateTo("/inventory");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
            _buttonText = "Add Item";
        }
    }
}
