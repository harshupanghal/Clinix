@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="clinix-nav-container">

    <!-- Topbar -->
    <header class="clinix-topbar" role="banner">
        <div class="clinix-topbar-left d-flex align-items-center">

            <!-- Mobile menu toggle -->
            <button class="btn icon-btn d-md-none" aria-label="Toggle menu" @onclick="ToggleMobileSidebar">
                <i class="bi bi-list fs-5"></i>
            </button>

            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center fw-bold ms-2" href="/">
                <i class="bi bi-hospital fs-4 text-primary"></i>
                <span class="brand-text d-none d-md-inline">Clinix</span>
            </a>

            <!-- Desktop Collapse toggle -->
            <button class="btn btn-ghost d-none d-md-flex icon-btn ms-3"
                    @onclick="ToggleCollapse"
                    aria-pressed="@_isCollapsed"
                    title="Collapse Sidebar">
                <i class="bi bi-columns-gap"></i>
            </button>
        </div>

        <!-- Topbar Right -->
        <div class="clinix-topbar-right d-flex align-items-center gap-2">

            <button class="btn icon-btn d-none d-md-block" title="Notifications">
                <i class="bi bi-bell"></i>
            </button>

            @if (_isAuthenticated)
            {
                <div class="user-info-chip dropdown">
                    <button class="btn d-flex align-items-center gap-2"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle fs-5 text-primary"></i>
                        <div class="d-none d-lg-block text-start">
                            <div class="fw-medium text-dark small-truncate">@_userName</div>
                            <div class="text-muted small">@_userRole</div>
                        </div>
                        <i class="bi bi-chevron-down small text-muted"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <NavLink class="dropdown-item" href="profile">
                                <i class="bi bi-person me-2"></i>My Profile
                            </NavLink>
                        </li>
                        <li><hr class="dropdown-divider" /></li>
                        <li>
    <button class="dropdown-item text-danger d-flex align-items-center gap-2" @onclick="Logout">
        <i class="bi bi-box-arrow-right"></i>
        Log Out
    </button>
</li>

                    </ul>
                </div>
            }
            else
            {
                <NavLink class="btn btn-outline-primary btn-sm d-none d-sm-block" href="login">
                    <i class="bi bi-box-arrow-in-right me-1"></i> Log In
                </NavLink>
                <NavLink class="btn btn-primary btn-sm text-white ms-1" href="register">
                    <i class="bi bi-person-plus me-1"></i> Register
                </NavLink>
            }
        </div>
    </header>

    <!-- Sidebar -->
  <aside class="clinix-sidebar @(_mobileSidebarOpen ? "open-mobile" : "")" role="navigation" aria-label="Main menu" data-collapsed="@_isCollapsed.ToString().ToLower()">
    <div class="sidebar-content d-flex flex-column h-100">

        <!-- Main Navigation -->
        <nav class="flex-grow-1 px-2 py-3 custom-scrollbar">
            <ul class="nav flex-column gap-1" role="menu">

                <li class="nav-item">
                    <NavLink class="nav-link" href="" Match="NavLinkMatch.All" @onclick="CloseMobileSidebar">
                        <i class="bi bi-speedometer"></i>
                        <span class="link-text">Dashboard</span>
                    </NavLink>
                </li>

                @if (_isAuthenticated)
                {
                    @if (_userRole == "Patient")
                    {
                        <li class="nav-section mt-3">Patient Portal</li>
                        <li class="nav-item"><NavLink class="nav-link" href="my-appointments" @onclick="CloseMobileSidebar"><i class="bi bi-calendar-event"></i><span class="link-text">Appointments</span></NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="book-appointment" @onclick="CloseMobileSidebar"><i class="bi bi-plus-circle"></i><span class="link-text">Book New</span></NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="health-records" @onclick="CloseMobileSidebar"><i class="bi bi-file-earmark-medical"></i><span class="link-text">Health Records</span></NavLink></li>
                    }

                    @if (_userRole == "Doctor")
                    {
                        <li class="nav-section mt-3">Doctor Workflow</li>
                        <li class="nav-item"><NavLink class="nav-link" href="schedule" @onclick="CloseMobileSidebar"><i class="bi bi-calendar-range"></i><span class="link-text">My Schedule</span></NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="patient-list" @onclick="CloseMobileSidebar"><i class="bi bi-people"></i><span class="link-text">Patient List</span></NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="follow-ups" @onclick="CloseMobileSidebar"><i class="bi bi-arrow-repeat"></i><span class="link-text">Follow-ups</span></NavLink></li>
                    }

                    @if (_userRole == "Admin")
                    {
                        <li class="nav-section mt-3">Admin Console</li>
                        <li class="nav-item"><NavLink class="nav-link" href="inventory" @onclick="CloseMobileSidebar"><i class="bi bi-box-seam"></i><span class="link-text">Inventory</span></NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="staff-management" @onclick="CloseMobileSidebar"><i class="bi bi-person-lines-fill"></i><span class="link-text">Staff Mgmt</span></NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="settings" @onclick="CloseMobileSidebar"><i class="bi bi-gear"></i><span class="link-text">System Settings</span></NavLink></li>
                    }
                }
            </ul>
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer px-3 py-2 border-top">
            @if (_isAuthenticated)
            {
                <button class="btn danger w-100" @onclick="Logout">
                    <i class="bi bi-box-arrow-right me-2"></i> Log Out
                </button>
            }

            <div class="text-muted d-flex justify-content-between mt-2">
                <span class="small-text">v1.0.0</span>
                <span class="small-text link-text">&copy; Clinix</span>
            </div>
        </div>
    </div>
</aside>


    <!-- Mobile Overlay -->
    <div class="mobile-overlay @( _mobileSidebarOpen ? "open" : "")" @onclick="CloseMobileSidebar"></div>
</div>

@code {
    private bool _isAuthenticated;
    private string _userName = "User";
    private string _userRole = "User";
    private bool _isCollapsed = false;
    private bool _mobileSidebarOpen = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        if (_isAuthenticated)
        {
            _userName = user.Identity?.Name ?? "User";
            _userRole = user.FindFirst(ClaimTypes.Role)?.Value ?? user.FindFirst("role")?.Value ?? "User";
        }
    }

    private void ToggleCollapse() => _isCollapsed = !_isCollapsed;
    private void ToggleMobileSidebar() => _mobileSidebarOpen = !_mobileSidebarOpen;
    private void CloseMobileSidebar() => _mobileSidebarOpen = false;
    private void Logout() => Navigation.NavigateTo("logout", forceLoad: true);
}
